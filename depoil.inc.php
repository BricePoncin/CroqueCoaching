<?PHP

		
		$liste_equipements[0] = array("id" => 0 , "name"=>"Ombres portées"                  ,"prix" =>  200, "image"=>"/gfx/tech/icone_ombres.gif"     , "stat" => "sad", "effet" => 1);
		$liste_equipements[1] = array("id" => 1 , "name"=>"Porte manteau à mémoire de forme","prix" => 1000, "image"=>"/gfx/tech/icone_manteau.gif"    , "stat" => "sad", "effet" => 1);
		$liste_equipements[2] = array("id" => 2 , "name"=>"Ardoise d'école"                 ,"prix" => 2000, "image"=>"/gfx/tech/icone_ardoise.gif"    , "stat" => "sad", "effet" => 2);
		$liste_equipements[3] = array("id" => 3 , "name"=>"Crème à acné"                    ,"prix" =>  200, "image"=>"/gfx/tech/icone_acnee.gif"      , "stat" => "ugl", "effet" => 1);
		$liste_equipements[4] = array("id" => 4 , "name"=>"Chapeau vivant dentu"            ,"prix" => 1000, "image"=>"/gfx/tech/icone_chapo.gif"      , "stat" => "ugl", "effet" => 1);
		$liste_equipements[5] = array("id" => 5 , "name"=>"Insectes dressés"                ,"prix" => 2000, "image"=>"/gfx/tech/icone_insecte.gif"    , "stat" => "ugl", "effet" => 2);
		$liste_equipements[6] = array("id" => 6 , "name"=>"Dessin animé humain"             ,"prix" =>  200, "image"=>"/gfx/tech/icone_da.gif"				  , "stat" => "pow", "effet" => 1);
		$liste_equipements[7] = array("id" => 7 , "name"=>"Fouet chatouilleur"              ,"prix" => 1000, "image"=>"/gfx/tech/icone_fouet.gif"      , "stat" => "pow", "effet" => 1);
		$liste_equipements[8] = array("id" => 8 , "name"=>"Bras monstrueux"                 ,"prix" => 2000, "image"=>"/gfx/tech/icone_bras.gif"       , "stat" => "pow", "effet" => 2);
		$liste_equipements[9] = array("id" => 9 , "name"=>"Petit vomi"                      ,"prix" =>  200, "image"=>"/gfx/tech/icone_vomi.gif"       , "stat" => "gre", "effet" => 1);
		$liste_equipements[10]= array("id" => 10, "name"=>"Lavage d'estomac"                ,"prix" =>  500, "image"=>"/gfx/tech/icone_stomac.gif"     , "stat" => "gre", "effet" => 2);
		$liste_equipements[11]= array("id" => 11, "name"=>"Régime diététique"               ,"prix" => 1000, "image"=>"/gfx/tech/icone_regime.gif"     , "stat" => "gre", "effet" => 1);
		$liste_equipements[12]= array("id" => 12, "name"=>"Ver solitaire"                   ,"prix" => 2000, "image"=>"/gfx/tech/icone_ver.gif"        , "stat" => "gre", "effet" => 2);
		$liste_equipements[13]= array("id" => 13, "name"=>"Poupée souffre-douleur"          ,"prix" =>  200, "image"=>"/gfx/tech/icone_doll.gif"       , "stat" => "con", "effet" => 1);
		$liste_equipements[14]= array("id" => 14, "name"=>"Balles anti-stress"              ,"prix" => 1000, "image"=>"/gfx/tech/icone_ball.gif"       , "stat" => "con", "effet" => 1);
		$liste_equipements[15]= array("id" => 15, "name"=>"Casque électrochoc"              ,"prix" => 2000, "image"=>"/gfx/tech/icone_electrochoc.gif", "stat" => "con", "effet" => 2);
		$liste_equipements[16]= array("id" => 16, "name"=>"Entrainement monstrueux"         ,"prix" =>    0, "image"=>"/gfx/tech/icone_oldtraining.gif", "stat" => "end", "effet" => 1);
		$liste_equipements[17]= array("id" => 17, "name"=>"Dopamonstre"                     ,"prix" =>    0, "image"=>"/gfx/tech/icone_dopa.gif"       , "stat" => "end", "effet" => 2);
		$liste_equipements[18]= array("id" => 18, "name"=>"Sieste dodo piquant"             ,"prix" =>    0, "image"=>"/gfx/tech/icone_dodo.gif");
		$liste_equipements[19]= array("id" => 19, "name"=>"Hypnododo"                       ,"prix" =>    0, "image"=>"/gfx/tech/icone_hypno.gif");
		$liste_equipements[20]= array("id" => 20, "name"=>"Bras temporaires"                ,"prix" =>  200, "image"=>"/gfx/tech/icone_bras2.gif"      , "stat" => "fig", "effet" => 1);
		$liste_equipements[21]= array("id" => 21, "name"=>"Slip grattant"                   ,"prix" => 1000, "image"=>"/gfx/tech/icone_slip.gif"       , "stat" => "fig", "effet" => 1);
		$liste_equipements[22]= array("id" => 22, "name"=>"Hache grotesque"                 ,"prix" => 2000, "image"=>"/gfx/tech/icone_hache.gif"      , "stat" => "fig", "effet" => 2);
		$liste_equipements[23]= array("id" => 23, "name"=>"Mallette vivante"                ,"prix" => 1000, "image"=>"/gfx/tech/icone_malette.gif");
		$liste_equipements[24]= array("id" => 24, "name"=>"Tripatouilleur de portail"       ,"prix" => 1000, "image"=>"/gfx/tech/icone_sabotage.gif");
		$liste_equipements[25]= array("id" => 25, "name"=>"Disrupteur de portail"           ,"prix" => 2000, "image"=>"/gfx/tech/icone_distru.gif");
		$liste_equipements[26]= array("id" => 26, "name"=>"Régulateur de marché VRP"        ,"prix" => 4000, "image"=>"/gfx/tech/icone_detour.gif");
		$liste_equipements[27]= array("id" => 27, "name"=>"Chapeau ZinZin"                  ,"prix" =>    0, "image"=>"/gfx/tech/icone_zinzin.gif");
		$liste_equipements[28]= array("id" => 28, "name"=>"Chapeau Lutin"                   ,"prix" =>    0, "image"=>"/gfx/tech/icone_lutin.gif");
		$liste_equipements[29]= array("id" => 29, "name"=>"Porte monnaie Bigbluff"          ,"prix" => 4000, "image"=>"/gfx/tech/icone_bourse.gif");
		$liste_equipements[30]= array("id" => 30, "name"=>"Sblurbotron"                     ,"prix" =>    0, "image"=>"/gfx/tech/icon_sblurb.gif");
		$liste_equipements[31]= array("id" => 31, "name"=>"Dop-Dopage"                      ,"prix" => 5000, "image"=>"/gfx/tech/icone_mbldop.gif");
		$liste_equipements[32]= array("id" => 32, "name"=>"Part de gâteau d'anniversaire"   ,"prix" =>    0, "image"=>"/gfx/tech/icones_cake.gif");


		function my_array_fill_keys($array, $values) 
		{
		    if(is_array($array)) 
		    {
		        foreach($array as $key => $value) 
		        {
		            $arraydisplay[$array[$key]] = $values;
		        }
		    }
		    return $arraydisplay;
		}
  
		function array_compile ( $tableau_cles, $tableau_valeurs )
		{
			$arResults = array();
			
			foreach( $tableau_cles as $idx => $cles )
				$arResults[$cles] = $tableau_valeurs[$cles];
			
				return $arResults;
		}

		function equipement_stat( $tab_equip, $tab_tempo=array() )
		{
			
				$array_cles = array("sad","ugl","pow","gre","con","fig","end") ;
				$arResult = my_array_fill_keys ( $array_cles , 0 );
				
				foreach( $tab_equip as $equip )
				{
					if ( isset($equip["stat"]) && ( isset($arResult[ $equip["stat"] ] ) ) )
					{
							$arResult[ $equip["stat"] ] += $equip["effet"];
					}
				}
				
				foreach( $tab_tempo as $equip )
				{
					if ( isset($equip["stat"]) && ( isset($arResult[ $equip["stat"] ] ) ) )
					{
							$arResult[ $equip["stat"] ] += $equip["effet"];
					}
				}

				
				return $arResult;
		}

		function pct_reussite( $stat_dem, $stat_pres, $diff)
		{
				$ret = 100 + 5 * ($stat_pres - $stat_dem) - $diff;
					
				$ret = max (5, $ret);
				$ret = min (100, $ret);
				
				return($ret);
		}

		function pct_manger( $mtr_greediness, $mtr_control, $crt_diff, $crt_kind )
		{
				$coeff=0;
				
				switch($crt_kind)
				{
				case '1': $coeff = 1;   break;
				case '2': $coeff = 1.5; break;
				case '3': $coeff = 2;   break;
				}
				
				$ret = 100 + ( 5 * ($mtr_control - ($coeff * $mtr_greediness)) );
				$ret = max (  5, $ret);
				$ret = min (100, $ret);
				
				return(ret);
		}

		function monstro_meilleurs_equipements( &$monstr_result, $equipements, $nom_stat, $contrat )
		{
				global $liste_equipements;
				global $debug;
			
				switch($nom_stat)
				{
				case 'sadism'    : $stat_tmp_1 =  0; $stat_tmp_2 = ''; $stat_def_1 =  1; $stat_def_2 =  2;break;
				case 'ugliness'  : $stat_tmp_1 =  3; $stat_tmp_2 = ''; $stat_def_1 =  4; $stat_def_2 =  5;break;
				case 'power'     : $stat_tmp_1 =  6; $stat_tmp_2 = ''; $stat_def_1 =  7; $stat_def_2 =  8;break;
				case 'greediness': $stat_tmp_1 =  9; $stat_tmp_2 = 10; $stat_def_1 = 11; $stat_def_2 = 12;break;
				case 'control'   : $stat_tmp_1 = 13; $stat_tmp_2 = ''; $stat_def_1 = 14; $stat_def_2 = 15;break;
				}
				
				if($debug)
				echo "$nom_stat => $stat_tmp_1; $stat_tmp_2; $stat_def_1; $stat_def_2;<br>\n";
				
				$pct_restant = 100-pct_reussite( $contrat[$nom_stat], $monstr_result[$nom_stat], $contrat['difficulty']);
				
				if($debug)
				echo " Demandé : ".$contrat[$nom_stat]."; Monstre : ".$monstr_result[$nom_stat]."; Difficulté  ".$contrat['difficulty']."<br/>\n";
				
				if($debug)
				echo "pct_restant : $pct_restant<br/>\n";
				
				if($debug) echo "$nom_stat avant : ".$monstr_result[$nom_stat]."<br/>\n";
				
				if (($pct_restant > 0) && ($pct_restant <= 5))
				{
						if( !isset($equipements[$stat_tmp_1]) ) 
						{
								if($debug) echo "On ajoute ".$liste_equipements[$stat_tmp_1]['name']." ". $liste_equipements[$stat_tmp_1]['effet']."<br/>\n";
								$monstr_result['equip'][$stat_tmp_1]=$liste_equipements[$stat_tmp_1];
								$monstr_result[$nom_stat] = $monstr_result[$nom_stat]+$liste_equipements[$stat_tmp_1]['effet']; 
						}
						else if( !isset($equipements[$stat_def_1]) )
						{
							if($debug) echo "On ajoute ".$liste_equipements[$stat_def_1]['name']." ". $liste_equipements[$stat_def_1]['effet']."<br/>\n";
							$monstr_result['equip'][$stat_def_1]=$liste_equipements[$stat_def_1];
							$monstr_result[$nom_stat] = $monstr_result[$nom_stat]+$liste_equipements[$stat_def_1]['effet']; 
						}
				}
				else if (($pct_restant > 5) && ($pct_restant <= 10 ))
				{
					if( ($stat_tmp_2!='') && ( !isset($equipements[$stat_tmp_2])) )
					{
						if($debug) echo "On ajoute ".$liste_equipements[$stat_tmp_2]['name']." ". $liste_equipements[$stat_tmp_2]['effet']."<br/>\n";
						$monstr_result['equip'][$stat_tmp_2]=$liste_equipements[$stat_tmp_2];
						$monstr_result[$nom_stat] = $monstr_result[$nom_stat]+$liste_equipements[$stat_tmp_2]['effet']; 
					}
					else if ( !isset($equipements[$stat_def_2]) )
					{                             
						if($debug) echo "On ajoute ".$liste_equipements[$stat_def_2]['name']." ". $liste_equipements[$stat_def_2]['effet']."<br/>\n";
						$monstr_result['equip'][$stat_def_2]=$liste_equipements[$stat_def_2];
						$monstr_result[$nom_stat] = $monstr_result[$nom_stat]+$liste_equipements[$stat_def_2]['effet']; 
					}
					else
					{	
						if( !isset($equipements[$stat_tmp_1]) )
						{
							if($debug) echo "On ajoute ".$liste_equipements[$stat_tmp_1]['name']." ". $liste_equipements[$stat_tmp_1]['effet']."<br/>\n";
							$monstr_result['equip'][$stat_tmp_1]=$liste_equipements[$stat_tmp_1];
							$monstr_result[$nom_stat] = $monstr_result[$nom_stat]+$liste_equipements[$stat_tmp_1]['effet']; 
						}
						if( !isset($equipements[$stat_def_1]) )
						{
							if($debug) echo "On ajoute ".$liste_equipements[$stat_def_1]['name']." ". $liste_equipements[$stat_def_1]['effet']."<br/>\n";
							$monstr_result['equip'][$stat_def_1]=$liste_equipements[$stat_def_1];
							$monstr_result[$nom_stat] = $monstr_result[$nom_stat]+$liste_equipements[$stat_def_1]['effet']; 
						}
					}
				}
				else if ($pct_restant > 10)
				{
					if( ($stat_tmp_2!='') && ( !isset($equipements[$stat_tmp_2])) )
					{
						if($debug) echo "On ajoute ".$liste_equipements[$stat_tmp_2]['name']." ". $liste_equipements[$stat_tmp_2]['effet']."<br/>\n";
						$monstr_result['equip'][$stat_tmp_2]=$liste_equipements[$stat_tmp_2];
						$monstr_result[$nom_stat] = $monstr_result[$nom_stat]+$liste_equipements[$stat_tmp_2]['effet']; 
					}
					if( !isset($equipements[$stat_def_2]) )
					{
						if($debug) echo "On ajoute ".$liste_equipements[$stat_def_2]['name']." ". $liste_equipements[$stat_def_2]['effet']."<br/>\n";
						$monstr_result['equip'][$stat_def_2]=$liste_equipements[$stat_def_2];
						$monstr_result[$nom_stat] = $monstr_result[$nom_stat]+$liste_equipements[$stat_def_2]['effet']; 
					}
					if( !isset($equipements[$stat_tmp_1]) )
					{
						if($debug) echo "On ajoute ".$liste_equipements[$stat_tmp_1]['name']." ". $liste_equipements[$stat_tmp_1]['effet']."<br/>\n";
						$monstr_result['equip'][$stat_tmp_1]=$liste_equipements[$stat_tmp_1];
						$monstr_result[$nom_stat] = $monstr_result[$nom_stat]+$liste_equipements[$stat_tmp_1]['effet']; 
					}
					if( !isset($equipements[$stat_def_1]) )
					{
						if($debug) echo "On ajoute ".$liste_equipements[$stat_def_1]['name']." ". $liste_equipements[$stat_def_1]['effet']."<br/>\n";
						$monstr_result['equip'][$stat_def_1]=$liste_equipements[$stat_def_1];
						$monstr_result[$nom_stat] = $monstr_result[$nom_stat]+$liste_equipements[$stat_def_1]['effet']; 
					}
				}
			
			if($debug) echo "$nom_stat apres : ".$monstr_result[$nom_stat]."<br/>\n";
				if($debug)
						echo "#####################<BR/>\n";
		}


    function monstro_habillage ( $monstre, $contrat )
    {
        global $liste_equipements;
        global $debug;
                
        $equipements_portes = explode(",", $monstre['permanentItems'].",".$monstre['contractItems']);
        $equipements = array_compile  ( $equipements_portes  , $liste_equipements  );
        
        $stats_equipement = equipement_stat($equipements);
        $monstr_result = $monstre;
        
        $list_caracs=array("power","ugliness", "greediness", "sadism", "control");
        
        foreach( $list_caracs as $carac )
        {
        		if ($contrat[$carac] > 0 )
        				monstro_meilleurs_equipements( $monstr_result, $equipements, $carac, $contrat );
        }
        
        if ($debug) print_r($monstre);
        if ($debug) print_r($monstr_result);
        if ($debug) echo "#####################<BR/>\n";
        
        return $monstr_result;
    }
			/*				
				if ($contrat['power'] > 0 )
				{
						$stat='power';
						$pct_restant = 100-pct_reussite( $contrat[$stat], $monstr_result[$stat], $contrat['difficulty']);
				}
				if ($contrat['ugliness'] > 0 )
				{
					  if( !isset($equip_tempo[3]) && (pct_reussite( $contrat['ugliness'], $monstr_result['ugliness']+$liste_equipements[3]['effet'], $contrat['difficulty']) > pct_reussite( $contrat['ugliness'], $monstr_result['ugliness'], $contrat['difficulty']) ) ) { $monstr_result['equip'][3]=$liste_equipements[3]; $monstr_result['ugliness'] = $monstr_result['ugliness']+$liste_equipements[13]['effet']; }
					  if( !isset($equip_perm [4]) && (pct_reussite( $contrat['ugliness'], $monstr_result['ugliness']+$liste_equipements[4]['effet'], $contrat['difficulty']) > pct_reussite( $contrat['ugliness'], $monstr_result['ugliness'], $contrat['difficulty']) ) ) { $monstr_result['equip'][4]=$liste_equipements[4]; $monstr_result['ugliness'] = $monstr_result['ugliness']+$liste_equipements[14]['effet']; }
					  if( !isset($equip_perm [5]) && (pct_reussite( $contrat['ugliness'], $monstr_result['ugliness']+$liste_equipements[5]['effet'], $contrat['difficulty']) > pct_reussite( $contrat['ugliness'], $monstr_result['ugliness'], $contrat['difficulty']) ) ) { $monstr_result['equip'][5]=$liste_equipements[5]; $monstr_result['ugliness'] = $monstr_result['ugliness']+$liste_equipements[15]['effet']; }
				}
				if ($contrat['greediness'] > 0 )
				{
					  if( !isset($equip_tempo[ 9]) && (pct_reussite( $contrat['greediness'], $monstr_result['greediness']+$liste_equipements[ 9]['effet'], $contrat['difficulty']) > pct_reussite( $contrat['greediness'], $monstr_result['greediness'], $contrat['difficulty']) ) ) { $monstr_result['equip'][ 9]=$liste_equipements[ 9]; $monstr_result['greediness'] = $monstr_result['greediness']+$liste_equipements[13]['effet']; }
					  if( !isset($equip_tempo[10]) && (pct_reussite( $contrat['greediness'], $monstr_result['greediness']+$liste_equipements[10]['effet'], $contrat['difficulty']) > pct_reussite( $contrat['greediness'], $monstr_result['greediness'], $contrat['difficulty']) ) ) { $monstr_result['equip'][10]=$liste_equipements[10]; $monstr_result['greediness'] = $monstr_result['greediness']+$liste_equipements[14]['effet']; }
					  if( !isset($equip_perm [11]) && (pct_reussite( $contrat['greediness'], $monstr_result['greediness']+$liste_equipements[11]['effet'], $contrat['difficulty']) > pct_reussite( $contrat['greediness'], $monstr_result['greediness'], $contrat['difficulty']) ) ) { $monstr_result['equip'][11]=$liste_equipements[11]; $monstr_result['greediness'] = $monstr_result['greediness']+$liste_equipements[15]['effet']; }
					  if( !isset($equip_perm [12]) && (pct_reussite( $contrat['greediness'], $monstr_result['greediness']+$liste_equipements[12]['effet'], $contrat['difficulty']) > pct_reussite( $contrat['greediness'], $monstr_result['greediness'], $contrat['difficulty']) ) ) { $monstr_result['equip'][12]=$liste_equipements[12]; $monstr_result['greediness'] = $monstr_result['greediness']+$liste_equipements[15]['effet']; }
				}
				if ($contrat['sadism'] > 0 )
				{
					  if( !isset($equip_tempo[0]) && (pct_reussite( $contrat['sadism'], $monstr_result['sadism']+$liste_equipements[0]['effet'], $contrat['difficulty']) > pct_reussite( $contrat['sadism'], $monstr_result['sadism'], $contrat['difficulty']) ) ) { $monstr_result['equip'][0]=$liste_equipements[0]; $monstr_result['sadism'] = $monstr_result['sadism']+$liste_equipements[13]['effet']; }
					  if( !isset($equip_perm [1]) && (pct_reussite( $contrat['sadism'], $monstr_result['sadism']+$liste_equipements[1]['effet'], $contrat['difficulty']) > pct_reussite( $contrat['sadism'], $monstr_result['sadism'], $contrat['difficulty']) ) ) { $monstr_result['equip'][1]=$liste_equipements[1]; $monstr_result['sadism'] = $monstr_result['sadism']+$liste_equipements[14]['effet']; }
					  if( !isset($equip_perm [2]) && (pct_reussite( $contrat['sadism'], $monstr_result['sadism']+$liste_equipements[2]['effet'], $contrat['difficulty']) > pct_reussite( $contrat['sadism'], $monstr_result['sadism'], $contrat['difficulty']) ) ) { $monstr_result['equip'][2]=$liste_equipements[2]; $monstr_result['sadism'] = $monstr_result['sadism']+$liste_equipements[15]['effet']; }
				}
				if ($contrat['greediness'] == 0 )
				{
					  if( !isset($equip_tempo[13]) && (pct_manger($monstre['greediness'], $monstr_result['control']+$liste_equipements[13]['effet'], $contrat['difficulty'], $contrat['kind']) < pct_manger($monstr_result['greediness'], $monstr_result['control'], $contrat['difficulty'], $contrat['kind']) ) ) {$monstr_result['equip'][13]=$liste_equipements[13]; $monstr_result['control'] = $monstr_result['control']+$liste_equipements[13]['effet']; }
					  if( !isset($equip_tempo[14]) && (pct_manger($monstre['greediness'], $monstr_result['control']+$liste_equipements[14]['effet'], $contrat['difficulty'], $contrat['kind']) < pct_manger($monstr_result['greediness'], $monstr_result['control'], $contrat['difficulty'], $contrat['kind']) ) ) {$monstr_result['equip'][14]=$liste_equipements[14]; $monstr_result['control'] = $monstr_result['control']+$liste_equipements[14]['effet']; }
					  if( !isset($equip_tempo[15]) && (pct_manger($monstre['greediness'], $monstr_result['control']+$liste_equipements[15]['effet'], $contrat['difficulty'], $contrat['kind']) < pct_manger($monstr_result['greediness'], $monstr_result['control'], $contrat['difficulty'], $contrat['kind']) ) ) {$monstr_result['equip'][15]=$liste_equipements[15]; $monstr_result['control'] = $monstr_result['control']+$liste_equipements[15]['effet']; }
				}
				
			
	
				return $monstr_result;
		}
*/







?> 